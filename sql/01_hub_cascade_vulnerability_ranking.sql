-- ============================================================================
-- QUERY 1: Hub Airport Cascade Vulnerability Ranking
-- Skills: Window functions (RANK, NTILE), conditional aggregation, subquery
-- Business Q: Which hub airports are most vulnerable to cascade disruptions?
-- ============================================================================

WITH airport_metrics AS (
    SELECT
        origin AS airport,
        count(*) AS total_departures,
        round(avg(depdelayminutes), 1) AS avg_dep_delay,
        round(sum(CASE WHEN depdel15 = 1 THEN 1 ELSE 0 END) * 100.0 / count(*), 1) 
            AS pct_delayed_15plus,
        round(sum(cancelled) * 100.0 / count(*), 2) AS pct_cancelled,
        count(DISTINCT dest) AS route_count,
        count(DISTINCT iata_code_reporting_airline) AS airline_count,
        round(avg(CASE WHEN lateaircraftdelay > 0 THEN lateaircraftdelay END), 1) 
            AS avg_late_aircraft_delay
    FROM raw_bts_flights
    WHERE flightdate >= '2025-09-01'
    GROUP BY origin
    HAVING count(*) >= 1000
)
SELECT
    airport,
    total_departures,
    avg_dep_delay,
    pct_delayed_15plus,
    route_count,
    airline_count,
    avg_late_aircraft_delay,
    -- Cascade vulnerability score: weighted combination of factors
    round(
        (pct_delayed_15plus * 0.3) + 
        (COALESCE(avg_late_aircraft_delay, 0) * 0.1) + 
        (route_count * 0.05) + 
        (airline_count * 2.0),
        1
    ) AS cascade_vulnerability_score,
    RANK() OVER (ORDER BY 
        (pct_delayed_15plus * 0.3) + 
        (COALESCE(avg_late_aircraft_delay, 0) * 0.1) + 
        (route_count * 0.05) + 
        (airline_count * 2.0) DESC
    ) AS vulnerability_rank,
    NTILE(5) OVER (ORDER BY pct_delayed_15plus DESC) AS delay_quintile
FROM airport_metrics
ORDER BY cascade_vulnerability_score DESC
LIMIT 20;