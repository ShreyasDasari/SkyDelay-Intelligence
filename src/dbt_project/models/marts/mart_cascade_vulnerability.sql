{{
  config(materialized='table')
}}

with airport_summary as (
    select
        airport,
        count(*) as operating_days,
        sum(total_departures) as total_departures,
        round(avg(avg_dep_delay_min), 1) as avg_delay_min,
        round(avg(pct_delayed_15), 1) as avg_pct_delayed,
        round(avg(pct_cancelled), 2) as avg_pct_cancelled,
        max(routes_served) as max_routes_served,
        max(airlines_operating) as max_airlines,
        round(avg(avg_late_aircraft_delay), 1) as avg_late_aircraft_delay,
        round(avg(est_total_economic_impact), 0) as avg_daily_economic_impact,
        round(sum(est_total_economic_impact), 0) as total_economic_impact
    from {{ ref('mart_delay_economics') }}
    group by airport
    having sum(total_departures) >= 1000
),

scored as (
    select
        *,
        round(
            (avg_pct_delayed * 0.30)
            + (coalesce(avg_late_aircraft_delay, 0) * 0.10)
            + (max_routes_served * 0.05)
            + (max_airlines * 2.0), 1
        ) as cascade_vulnerability_score,
        rank() over (order by
            (avg_pct_delayed * 0.30)
            + (coalesce(avg_late_aircraft_delay, 0) * 0.10)
            + (max_routes_served * 0.05)
            + (max_airlines * 2.0) desc
        ) as vulnerability_rank
    from airport_summary
)

select * from scored
order by vulnerability_rank